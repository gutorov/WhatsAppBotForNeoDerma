### Бот для автоматической записи в салон красоты

#### Процесс запуска с докером(локально еще проще - создайте нужную БД, активируйте нгрок, добавьте переменные среды, например в идею - профит)

Примеры для работы на удаленном сервере, локально все чуть проще, но идея та же.
```
ngrok http 8090 - для работы через докер
ngrok http 8080 - для локального развертывания с локал БД
```

Для работы на удаленке нужно скачать нгрок и запускать в фоновом терминале
``` 
wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
tar -xvzf ngrok-v3-stable-linux-amd64.tgz
sudo mv ngrok /usr/local/bin
ngrok version
```

**запуск ngrok через screen(локально можно просто терминал отдельный держать открытым**
```
sudo apt-get install screen
screen -S ngrok-session
ngrok config add-authtoken 2jhUsIqHCAGrzBApOwzQz0eIPsg_4ib3MyNiPHezyGk8guWwD
ngrok http 8090
ngrok http --domain=singular-stingray-actually.ngrok-free.app 8090

Отключиться от сессии screen
Ctrl + A + D

Перейти снова в сессию с запущенным нгрок
screen -r ngrok-session
```
**Сохранить прокси-апи адрес нгрока такого типа  и добавить актуальный адрес в .env-файл с переменными среды**
``` 
Forwarding                    https://80fd-89-110-80-175.ngrok-free.app -> http://localhost:8080
```

**После запуска приложения активировать веб-хук на этот адрес сделав post-запрос**
``` 
в постмане локально
<ngrok_url>/webhook/activate-webhook
```
Это делается единожды после каждого перезапуска приложения и/или перезапуска самого сервиса ngrok

**Все сообщения, привязанные на текущий номер через чат-пуш будут приходить на наш ендпоинт , как пост-запрос на**
``` 
localhost:8090/webhook
```

Далее скачать из notion нужные файлы - id нужных страниц храняться в файле /src/main/resources/page_ids.txt
``` 
POST-запрос на
localhost:8090/notion/download_all_files
```
**После удачного скачивания файлы будут храниться в volume app_files_neoderma и далее скормить ембединговой БД нужные данные по актуальным сервисам через гет-запрос на**
``` 
в удаленном терминале
localhost:8090/load
локально в постмане
<ngrok_url>/load

```
**это может длиться 5-7 минут - смотреть по логам**

#### После этого приложение готово к работе.

### Ниже будет общая схема работы основных компонентов:



   
ЭТИ ДАННЫЕ НЕ АКТУАЛЬНЫ - ТОНКО-НАСТРОЕННАЯ МОДЕЛЬ ВЕДЁТ СЕБЯ ХУЖЕ, чем обычная с нормальным описанием тулов и системкой   
тонкая настройка модели

загрузить файл с настройками
пост запрос(проверить в контроллере верный путь к актуальному файлу)
http://localhost:8080/llm/upload_training_file
-> получить файл айди

пост запрос на начало обуча
http://localhost:8080/llm/create_fine_tuning_job?fileId=file-S8IFzfBLWa24QFUYw0SDGnmu
-> запомнить из ответа айди обуча "id": "ftjob-sz9dhtwfWD7OIXMYMdbIzkaA"

через пару минут - првоерить статус обуча
гет-запрос
http://localhost:8080/llm/get_status_fine_tuning_job?fineTuningJobId=ftjob-sz9dhtwfWD7OIXMYMdbIzkaA

ЗАПОМНИТЬ "fine_tuned_model": -> исползовать его для создание модели через LC4J


Описание данных для тренировки модели
1. Просто узнать даты работы и брони
2. -||-
3. -||-
4. промты для работы с тулом по показу всех услуг или поиску по ним
5. узнать есть ли конкретная услуга
6. узнать какие есть услуги определённого вида
7. -||-
8. -||-
9. узнать услуги + записаться на одну из них
10. узнать какие сотрудники есть
11. азпись к конкретного сотруднику
12. узнать услуги + сотрудников под услугу + записаться к кому-то
13. -||- + невалидный сотрудник
14. -||- + сотрудник неважен - ллм сам выбирает его
15. -||- + после записи клиент передумал и хочет выбтрать другого сотрудника
16. просто пример работы првоерки ближайшего времени
17. просто пример работы првоерки конкретной даты 
18. показ ближайшего времени и запись на нее
19. выбор конкретной даты и запись на нее
20. выбор времени без выбора услуги, услугу выбирает в конце после выбора даты и мастера
21. показ времени и выбор невалитдного времени с последующим перевыбором + запись этого времени
22. полное описание с услуга - мастер _ ближ дата + запись
23. полное описание с услуга - мастер _ конкретная дата + запись
24. полное описание с услуга - мастер _ конкретная дата = невалидная дата - нет свободных мест
25. полное описание - услуга - мастер -ближайшая дата - финал подтверждение
26. полное подтверждение с изменением сотрудника
27. полное описание, но с несохранёнными данными мастера и последующими  пересохранением

Очень краткая инструкция, как запустить и настроить приложение

- запустить нгрок и перед запуском приложения добавить прокси-урл нгрока в переменные среды
- запуск по дефолту на  8080
- обучить ассистента от lc4j через гет запрос на localhost:8080/load (обуч длиться минуты 3-5 - в векторную БД записываются все дто, которые поолучяены с яклиента и отражают общую информацию по имеющимся услугам)
- после успеха - можно писать на привязанный к чат-пушу номер телефона - все будет получать контроллер /webhook и отдавать в сервис по обработки ллм
- работает только не в РФ апи-адреса или с впн(опен аи...)
- можно удалять и получать историю сообщений по ендпоинтам LLMMemoryController(с получением через постман будет 500 ошибка, но в терминале история вся выведется), удаление работает с айди памяти - это же айди чата с чат-пуша
- мониторить нгрок - http://127.0.0.1:4040/inspect/http
- 



